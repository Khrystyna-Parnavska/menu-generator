{% extends "base.html" %}
{% block head %}
    <title>Menu</title>
{% endblock %}

{% block body %}

    <h3 style="text-align: center;">Choose meals to add:</h3>
    <form action="{{ url_for('init_plan') }}" method="POST">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 30px;">
            {% for meal in all_meals %}
            <label><input type="checkbox" name="meals" value="{{ meal['name'] }}" checked> {{ meal['name'] }}</label>
            {% endfor %}
        </div>
        {% if not success_message %} 
            <button type="submit" class="submit-btn">Generate Draft</button> 
        {% endif %}
    </form>

    {% if error %}
    <p style="color:red; text-align:center;">{{ error }}</p>
    {% endif %}

    {% if success_message %}
        <div style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #c3e6cb;">
            {{ success_message }}
        </div>
    {% endif %}

    {% if menu_meals %}
    <section id="draft" style="margin-top: 40px;">
        <h2 style="text-align: center;">Your Generated Menu</h2>

        <form id="final-menu-form" action="{{ url_for('submit_final_menu') }}" method="POST">
            <input type="hidden" name="menu_id" value="{{ menu_id }}">

            {% for meal_entry in menu_meals %}
<div class="menu-row-card">
    <input type="hidden" name="meal_id[]" value="{{ meal_entry['meal_id'] }}">
    <input type="hidden" name="recipe_id[]" value="{{ meal_entry['recipe_id'] }}">
    <input type="hidden" name="regenerated_times[]" value="{{ meal_entry['regenerated_times'] }}">
    <input type="hidden" name="if_picked_manually[]" value="{{ meal_entry['if_picked_manually'] }}">

    <div class="menu-time-container">
        <div class="time-badge" style="padding: 5px;">
            <input type="time" name="meal_time[]" value="{{ meal_entry['meal_time'] }}" 
                   class="custom-input" style="padding: 5px 10px; font-size: 0.9em;">
        </div>
    </div>

    <div class="menu-info">
        <span style="color: var(--text-pink); font-size: 0.8em; font-weight: bold; text-transform: uppercase;">
            {{ meal_entry['meal_type'] }}
        </span>
        <strong style="font-size: 1.1em; display: block; margin-top: 4px;">
            {{ meal_entry['recipe_name'] }}
        </strong>
    </div>

    <div style="flex-shrink: 0; width: 130px;">
        <a href="{{ url_for('recipe_details', recipe_id=meal_entry['recipe_id']) }}" class="action-btn">View Recipe</a>
        <label style="font-size: 0.8em; cursor: pointer; display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" name="leftover_{{ meal_entry['meal_id'] }}" value="1">  Use
            leftovers later
        </label>
    </div>

    <div class="action-group" style="flex-shrink: 0; width: 120px;">
        <button type="submit" form="regen-{{ loop.index }}" class="action-btn">Regenerate</button>
        <a href="{{ url_for('manual_search', meal_index=loop.index0) }}" 
           class="action-btn" 
           style="text-decoration: none; text-align: center; background-color: var(--bright-purple);">
           Pick Manually
        </a>
    </div>
</div>
{% endfor %}

            {% if not success_message %} 
                <button type="submit" class="submit-btn" style="width:100%">Submit Menu</button>
            {% endif %}
        </form>

        {% for meal_entry in menu_meals %}
        <form id="regen-{{ loop.index }}" action="{{ url_for('regenerate_meal', meal_id=loop.index0) }}" method="POST" style="display:none;"></form>
        {% endfor %}

    </section>
{% endif %}
{% endblock %}